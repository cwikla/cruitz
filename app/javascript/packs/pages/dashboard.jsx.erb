import React, { 
  Component
} from 'react';

import PropTypes from 'prop-types';
import ReactDOM from 'react-dom';
import { 
  render 
} from 'react-dom';

import {
  createStore,
  applyMiddleware
} from 'redux';

import {
  Provider
} from 'react-redux';

import Pyr from '../pyr/pyr';

import Container, { Row, Column } from './container';
import Sidebar from './side_bar';
import JobsPage, { JobSideButton } from './jobs/jobs_page';
import CandidatesPage, {CandidateSideButton} from './jobs/candidates_page';
import RecruitersPage from './recruiters_page';

const JOBS_PAGE = 'jobs';
const CANDIDATES_PAGE = 'candidates';
const RECRUITERS_PAGE = 'recruiters';

const JOBS_URL = "/jobs";

function ajaxError(jaXHR, textStatus, errorThrown) {
   alert(errorThrown);
}

function same(a,b) {
  return a.uuid == b.uuid;
}

class DashboardContainer extends Container {
  constructor(props) {
    super(props);

    this.state = {
      openPage: JOBS_PAGE,
      jobs: [],
      job: null,
    };

    this.onJobIndex = this.jobIndex.bind(this);
    this.onJobCreate = this.jobCreate.bind(this);
    this.onJobUpdate = this.jobUpdate.bind(this);
    this.onJobDelete = this.jobDelete.bind(this);
  }

  setPage(page) {
    this.setState({openPage: page});
    //alert(page);
  }

  getJobs() {
    $.getJSON({
      type: Pyr.Method.GET,
      url: JOBS_URL,
      context: this
    }).done(function(data, textStatus, jaXHR) {
        this.onJobIndex(data.jobs);
    }).fail(function(jaXHR, textStatus, errorThrown) {
      ajaxError(jaXHR, textStatus, errorThrown);
    });
  }

  componentDidMount() {
    this.getJobs();
  }

  same(j1, j2) {
    return j1.uuid == j2.uuid;
  }

  jobIndex(jobs) {
    this.setState({jobs});
  }

  jobCreate(job) {
    let newJobs = this.state.jobs.slice().push(job);
    this.onJobIndex(newJobs);
  }

  jobUpdate(job) {
    let newJobs = this.state.jobs.map((item) => {
      if (same(item, job)) {
        return job;
      }
      return item;
    });
    this.onJobIndex(newJobs);
  }

  jobDelete(job) {
    let pos = this.state.jobs.findIndex((item) => {
       return same(item, job);
    });
    if (pos) {
      let newJobs = this.state.jobs.slice(0, pos) + this.state.jobs.slice(pos+1);
      this.onJobIndex(newJobs);
    }
  }

  selectJob(e, job) {
    e.preventDefault();

    this.setState({
      openPage: CANDIDATES_PAGE,
      job: job
    });
  }

  render() {
    let self = this;

    let jobKids = this.state.jobs.map( (child) => {
        return (<Sidebar.Button 
                  key={child.uuid} 
                  selected={this.state.job && same(this.state.job, child)} 
                  onClick={(e) => self.selectJob(e, child) }>{child.title}</Sidebar.Button>
        );
      }
    );

    let title = this.state.job ? this.state.job.title : "Jobs";

    return(

      <Row>
        <Column className="col-md-2" id="sidebar">
          <Sidebar.Main {...this.props}>
            <Sidebar.Section selected={this.state.job} id="sidebar-jobs">
              <Sidebar.Header>Jobs</Sidebar.Header>
              <Sidebar.Menu>{jobKids}</Sidebar.Menu>
            </Sidebar.Section>
            <Sidebar.Header id="sidebar-recruiters"
              onClick={(e) => {e.preventDefault(); this.setPage(RECRUITERS_PAGE); } }
            >Recruiters</Sidebar.Header>
          </Sidebar.Main>
        </Column>
        <Column className="col-md-10" id="main-page">
          <Sidebar.Header>{title}</Sidebar.Header>
          <JobsPage 
             {...this.props.jobsPageProps} 
            selected={this.state.openPage==JOBS_PAGE} 
            jobs={this.state.jobs}
            onJobCreate={this.onJobCreate}
            onJobUpdate={this.onJobUpdate}
            onJobDelete={this.onJobDelete}
          />
          <CandidatesPage {...this.props.candidatePageProps} job={this.state.job} selected={this.state.openPage==CANDIDATES_PAGE} />
          <RecruitersPage {...this.props.recruiterPageProps} selected={this.state.openPage==RECRUITERS_PAGE} />
        </Column>
      </Row>
    );
  }
}

const Footer = (props) => (
  <div>Footer {props.name}!</div>
);

///
/// 
///

let store = createStore((state) => { return state; })

render(
  <Provider store={store}>
    <DashboardContainer />
  </Provider>,
  document.getElementById('container')
);
